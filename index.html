<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fotografie Kalkulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js">
</script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f4f8; padding: 20px 10px; color: #333; margin: 0; }
        
        .settings-toggle { position: fixed; top: 20px; right: 20px; z-index: 1001; background: #2c3e50; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; font-size: 20px; width: 50px; height: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #settings-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1002; overflow-y: auto; padding: 25px; box-sizing: border-box; }
        
        .calculator { max-width: 650px; margin: 70px auto 20px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #3498db; padding-bottom: 15px; }
        .logo-img { width: 150px; height: auto; object-fit: contain; margin: 0 auto 10px auto; display: block; }
        
        .section-title { font-size: 0.8em; font-weight: bold; text-transform: uppercase; color: #7f8c8d; margin: 25px 0 10px 0; display: block; border-bottom: 1px solid #eee; }
        .input-group { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .text-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        
        .custom-field-ui { background: #f0f7ff; padding: 10px; border-radius: 8px; border-left: 4px solid #3498db; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .shipping-box { background: #fff8f0; padding: 12px; border-radius: 8px; border-left: 4px solid #e67e22; margin-bottom: 12px; display: none; font-size: 0.9em; }
        
        input[type="number"] { width: 95px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .sub-options { background: #f9f9f9; padding: 12px; border-radius: 8px; margin-bottom: 12px; display: none; }

        .summary-box { background: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-top: 30px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95em; }
        .summary-total-row { border-top: 1px solid #576574; margin-top: 15px; padding-top: 15px; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.3em; }
        
        #pdf-export-area { width: 210mm; min-height: 297mm; padding: 20mm; background: white; color: black; box-sizing: border-box; margin: 0 auto; transform-origin: top center; }
        .pdf-header { display: flex; flex-direction: column; align-items: center; 
justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        #pdf-logo { width: 140px; height: auto !important; object-fit: contain; }
        .pdf-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 11pt; }
        
        .btn-preview { width: 100%; background: #3498db; color: white; border: none; padding: 16px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1em; }
        .config-row { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; }

        #preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; }
        .modal-content { background: #555; width: 98%; max-width: 850px; margin: 10px auto; border-radius: 8px; overflow: hidden; }
        .modal-footer { display: flex; gap: 10px; padding: 15px; background: #eee; position: sticky; bottom: 0; }

        @media screen and (max-width: 800px) {
            #pdf-export-area { transform: scale(0.42); margin-left: -28%; margin-top: -45%; }
        }
    </style>
</head>
<body>

<button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</button>


<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #3498db; margin-bottom:20px;">
        <h2>Einstellungen</h2>
        <button onclick="toggleSettings()" style="font-size:30px; background:none; border:none; cursor:pointer;">‚úï</button>
    </div>
    
    <span class="section-title">Standard Preise</span>
    <div id="settings-list"></div>

    <span class="section-title">Eigene Felder definieren</span>
    <div id="custom-config-container"></div>
    <button onclick="addCustomField()" style="width:100%; padding:12px; background:#3498db; color:white; border:none; border-radius:8px; margin-top:10px; font-weight:bold;">+ Neues Feld hinzuf√ºgen</button>

    <button onclick="resetPrices()" style="background:#e74c3c; color:white; border:none; padding:12px; border-radius:8px; margin-top:30px; width:100%;">Alles zur√ºcksetzen</button>
    <button class="btn-preview" onclick="toggleSettings()" style="background:#27ae60;">Schlie√üen</button>
</div>

<div class="calculator">
    <div class="header">
        <img id="main-logo" src="" alt="Logo" class="logo-img" style="display:none;">
        <div style="font-size: 27px; font-weight: bold; color: #1D3E59;">Fotografie Rechner</div>
    </div>

    <input type="text" id="kunde" class="text-input" placeholder="Name des Kunden">
    <input type="text" id="anlass" class="text-input" placeholder="Anlass">
    <input type="text" id="datumOrt" class="text-input" placeholder="Datum / Ort">

    <span class="section-title">Leistungen</span>
    <div class="input-group"><label>Shooting (Std.)</label><input type="number" id="vorOrt" value="0" oninput="updateAll()"></div>
    <div class="input-group"><label>Nachbearbeitung (Std.)</label><input type="number" id="bearbeitung" value="0" readonly></div>
    <div class="input-group"><label>Anfahrt (km)</label><input type="number" id="km" value="0" oninput="updateAll()"></div>
    <div id="ui-leistungen-custom"></div>

    <span class="section-title">Produkte & Fotobox</span>
    <div class="input-group"><label>Abz√ºge (Anzahl)</label><input type="number" id="abzuege" value="0" oninput="updateAll()"></div>
    
    <div class="input-group"><label>USB-Stick</label><div style="display:flex; gap:10px;"><label><input type="radio" name="usb_choice" value="ja" onchange="updateAll()"> Ja</label><label><input type="radio" name="usb_choice" value="nein" checked onchange="updateAll()"> Nein</label></div></div>
    <div id="ship_usb_box" class="shipping-box">Versand USB (‚Ç¨): <input type="number" id="versandUsb" value="0" oninput="updateAll()"></div>

    <div class="input-group"><label>Geschenkbox</label><div style="display:flex; gap:10px;"><label><input type="radio" name="geschenk_choice" value="ja" onchange="updateAll()"> Ja</label><label><input type="radio" name="geschenk_choice" value="nein" checked onchange="updateAll()"> Nein</label></div></div>
    <div id="ship_geschenk_box" class="shipping-box">Versand Geschenkbox (‚Ç¨): <input type="number" id="versandGeschenk" value="0" oninput="updateAll()"></div>

    <div class="input-group"><label>Fotobox-System</label><div style="display:flex; gap:10px;"><label><input type="radio" name="fotobox" value="ja" onchange="updateAll()"> Ja</label><label><input type="radio" name="fotobox" value="nein" checked onchange="updateAll()"> Nein</label></div></div>
    <div id="fotobox_options" class="sub-options">
        <label><input type="radio" name="papier" value="0" checked onchange="updateAll()"> Nur Digital</label><br>
        <label><input type="radio" name="papier" value="400" onchange="updateAll()"> 400 Blatt Flatrate</label><br>
        <label><input type="radio" name="papier" value="800" onchange="updateAll()"> 800 Blatt Flatrate</label>
    </div>

    <div id="ui-produkte-custom"></div>

    <div class="summary-box">
        <div class="summary-item"><span>Summe Leistungen:</span><span id="sumLeistung">0,00 ‚Ç¨</span></div>
        <div class="summary-item"><span>Summe Produkte:</span><span id="sumProdukt">0,00 ‚Ç¨</span></div>
	<div class="summary-item"><span>Summe Versand:</span><span id="sumVersand">0,00 ‚Ç¨</span></div>
        <div class="summary-total-row"><span>Gesamtbetrag:</span><span id="total">0,00 ‚Ç¨</span></div>
    </div>

    <button class="btn-preview" onclick="showPreview()">Vorschau & PDF</button>
</div>

<div id="preview-modal">
    <div class="modal-content">
        <div id="pdf-export-area">
            <div class="pdf-header" style="text-align:center; margin-bottom:30px;">
    <img id="pdf-logo" style="max-width:160px; margin:0 auto 10px auto; display:block;">
    <h1 style="margin:0;">Angebot</h1>
</div>

<div style="display:flex; justify-content:space-between; margin-bottom:25px;">
    <strong id="pdf-out-kunde" style="font-size:1.1em;"></strong>
    <span id="pdf-out-datum" style="color:#555;"></span>
</div>

<div style="margin-bottom:25px;">
    <span id="pdf-out-anlass"></span><br>
    <span id="pdf-out-ort" style="color:#555;"></span>
</div>

            <div id="pdf-rows"></div>
            <div id="pdf-final-sum" style="margin-top: 30px; font-size: 1.4em; font-weight: bold; text-align: right; border-top: 2px solid #000; padding-top: 15px;"></div>
        </div>
        <div class="modal-footer">
            <button onclick="closePreview()" style="flex:1; padding:15px; background:#95a5a6; color:white; border:none; border-radius:8px;">Zur√ºck</button>
            <button id="pdf-btn" onclick="downloadPDF()" style="flex:1; padding:15px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold;">PDF Speichern</button>
        </div>
    </div>
</div>

<script>
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

const LOGO_BASE64 = ""; 

const DEFAULTS = {
    stdVorOrt: 80,
    stdBearb: 50,
    abzug: 0.50,
    saalShip: 5.29,
    usb: 15,
    geschenk: 12,
    box: 150,
    p400: 55.31,
    p800: 110.62,
    pShip: 6.95,
    kmSatz: 0.31,
    kmFrei: 50
};

const LABELS = {
    stdVorOrt: "Stundensatz Shooting",
    stdBearb: "Stundensatz Bearb.",
    abzug: "Preis Abzug",
    saalShip: "Versand Saal",
    usb: "Preis USB",
    geschenk: "Preis Geschenkbox",
    box: "Miete Fotobox",
    p400: "Papier 400 Blatt",
    p800: "Papier 800 Blatt",
    pShip: "Versand Papier",
    kmSatz: "KM-Satz",
    kmFrei: "Frei-KM"
};

let PREISE = JSON.parse(localStorage.getItem('fotoPrices')) || { ...DEFAULTS };
let CUSTOM_FIELDS = JSON.parse(localStorage.getItem('fotoCustomFields')) || [];

function formatDateDE(date = new Date()) {
    return date.toLocaleDateString('de-DE', {
        day: '2-digit',
        month: 'long',
        year: 'numeric'
    });
}

    const LOGO_BASE64 = ""; 


function downloadPDF() {

    if (isMobile) {
        alert(
            "Das PDF kann auf dem Smartphone leider nicht zuverl√§ssig erstellt werden.\n\n" +
            "Bitte √∂ffne den Rechner am Desktop oder Laptop."
        );
        return;
    }

    const el = document.getElementById('pdf-export-area');
    const k = document.getElementById('kunde').value.replace(/\s+/g, '_') || "Kunde";
    const a = document.getElementById('anlass').value.replace(/\s+/g, '_') || "Angebot";

    html2pdf().from(el).set({
        margin: 10,
        filename: `Angebot_${k}_${a}.pdf`,
        html2canvas: {
            scale: 2.5,
            useCORS: true
        },
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        }
    }).save();
}

initSettings();
updateAll();

if (isMobile) {
    const btn = document.getElementById('pdf-btn');
    if (btn) {
        btn.innerText = "PDF bitte am Desktop herunterladen";
    }
}




    function initSettings() {


        const list = document.getElementById('settings-list');
        list.innerHTML = '';
        for (let key in PREISE) {
            list.innerHTML += `<div class="input-group"><label style="font-size:0.8em;">${LABELS[key]}</label><input type="number" step="0.01" value="${PREISE[key]}" oninput="updatePrice('${key}', this.value)"></div>`;
        }
        renderConfigUI();
        renderMainUIFields();
    }

    function renderConfigUI() {
        const container = document.getElementById('custom-config-container');
        container.innerHTML = '';
        CUSTOM_FIELDS.forEach((f, i) => {
            container.innerHTML += `<div class="config-row"><input type="text" placeholder="Name" value="${f.name}" oninput="updateField(${i},'name',this.value)" style="width:90%;margin-bottom:5px;"><div style="display:flex;justify-content:space-between;"><input type="number" value="${f.price}" oninput="updateField(${i},'price',this.value)" style="width:70px;"><select onchange="updateField(${i},'type',this.value)"><option value="leistung" ${f.type==='leistung'?'selected':''}>Leistung</option><option value="produkt" ${f.type==='produkt'?'selected':''}>Produkt</option></select><button onclick="removeField(${i})" style="color:red;border:none;background:none;">‚úï</button></div></div>`;
        });
    }
function renderAll() {
    renderConfigUI();
    renderMainUIFields();
    updateAll();
}

    function renderMainUIFields() {
        const lDiv = document.getElementById('ui-leistungen-custom');
        const pDiv = document.getElementById('ui-produkte-custom');
        lDiv.innerHTML = ''; pDiv.innerHTML = '';
        CUSTOM_FIELDS.forEach((f, i) => {
            if(!f.name) return;
            const html = `<div class="custom-field-ui"><label><strong>${f.name}</strong> (${f.price.toFixed(2)}‚Ç¨)</label><input type="checkbox" ${f.active?'checked':''} onchange="toggleActive(${i},this.checked)"></div>`;
            if(f.type==='leistung') lDiv.innerHTML += html; else pDiv.innerHTML += html;
        });
    }

    function addCustomField() {
    CUSTOM_FIELDS.push({
        name: '',
        price: 0,
        type: 'leistung',
        active: false
    });

    localStorage.setItem(
        'fotoCustomFields',
        JSON.stringify(CUSTOM_FIELDS)
    );

    renderAll(); // üî• DAS ist der entscheidende Punkt
}

    function updateField(i,k,v) { CUSTOM_FIELDS[i][k] = k==='price'?parseFloat(v)||0:v; saveAndReload(); }
    function toggleActive(i,v) { CUSTOM_FIELDS[i].active = v; saveAndReload(); }
    function removeField(i) { CUSTOM_FIELDS.splice(i,1); saveAndReload(); }
    function saveAndReload() { localStorage.setItem('fotoCustomFields', JSON.stringify(CUSTOM_FIELDS)); renderMainUIFields(); updateAll(); }
    function updatePrice(k,v) { PREISE[k]=parseFloat(v)||0; localStorage.setItem('fotoPrices',JSON.stringify(PREISE)); updateAll(); }
    function resetPrices() { if(confirm("Alles l√∂schen?")){localStorage.clear(); PREISE={...DEFAULTS}; CUSTOM_FIELDS=[]; initSettings(); updateAll();}}
    function toggleSettings() { const o=document.getElementById('settings-overlay'); o.style.display=o.style.display==='block'?'none':'block'; }

    if(LOGO_BASE64) { document.getElementById('main-logo').src=LOGO_BASE64; document.getElementById('main-logo').style.display='block'; document.getElementById('pdf-logo').src=LOGO_BASE64; }

    function updateAll() {
    const fmt = (v) =>
        v.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });

    /* ========= Basiswerte ========= */
    const vOrt = parseFloat(document.getElementById('vorOrt').value) || 0;
    const km = parseFloat(document.getElementById('km').value) || 0;
    const nAbz = parseInt(document.getElementById('abzuege').value) || 0;

    const usbJa =
        document.querySelector('input[name="usb_choice"]:checked').value === 'ja';
    const geschenkJa =
        document.querySelector('input[name="geschenk_choice"]:checked').value === 'ja';
    const boxJa =
        document.querySelector('input[name="fotobox"]:checked').value === 'ja';

    /* ========= Nachbearbeitung ========= */
    const tBearb = vOrt * 2.25;
    document.getElementById('bearbeitung').value = tBearb.toFixed(2);

    /* ========= Summen ========= */
    let sumL = 0;
    let sumP = 0;
    let sumVersand = 0;

    /* ========= Leistungen ========= */
    sumL += vOrt * PREISE.stdVorOrt;
    sumL += tBearb * PREISE.stdBearb;
    sumL += Math.max(0, km - PREISE.kmFrei) * PREISE.kmSatz;

    /* ========= Produkte & Versand ========= */

    // Abz√ºge
    if (nAbz > 0) {
        sumP += nAbz * PREISE.abzug;
        sumVersand += PREISE.saalShip;
    }

    // USB
    document.getElementById('ship_usb_box').style.display = usbJa
        ? 'block'
        : 'none';

    if (usbJa) {
        sumP += PREISE.usb;
        sumVersand +=
            parseFloat(document.getElementById('versandUsb').value) || 0;
    }

    // Geschenkbox
    document.getElementById('ship_geschenk_box').style.display = geschenkJa
        ? 'block'
        : 'none';

    if (geschenkJa) {
        sumP += PREISE.geschenk;
        sumVersand +=
            parseFloat(document.getElementById('versandGeschenk').value) || 0;
    }

    // Fotobox
    document.getElementById('fotobox_options').style.display = boxJa
        ? 'block'
        : 'none';

    if (boxJa) {
        sumP += PREISE.box;

        const pap = document.querySelector(
            'input[name="papier"]:checked'
        ).value;

        if (pap === '400') {
            sumP += PREISE.p400;
            sumVersand += PREISE.pShip;
        }
        if (pap === '800') {
            sumP += PREISE.p800;
            sumVersand += PREISE.pShip;
        }
    }

    /* ========= Custom Fields ========= */
    CUSTOM_FIELDS.forEach((f) => {
        if (!f.active) return;
        if (f.type === 'leistung') sumL += f.price;
        else sumP += f.price;
    });

    /* ========= Ausgabe ========= */
    document.getElementById('sumLeistung').innerText = fmt(sumL);
    document.getElementById('sumProdukt').innerText = fmt(sumP);
    document.getElementById('sumVersand').innerText = fmt(sumVersand);
    document.getElementById('total').innerText = fmt(sumL + sumP + sumVersand);
}

function downloadPDF() {

    if (isMobile) {
        alert(
            "Das PDF kann auf dem Smartphone leider nicht zuverl√§ssig erstellt werden.\n\n" +
            "Bitte √∂ffne den Rechner am Desktop oder Laptop."
        );
        return;
    }

    const el = document.getElementById('pdf-export-area');
    const k = document.getElementById('kunde').value.replace(/\s+/g, '_') || "Kunde";
    const a = document.getElementById('anlass').value.replace(/\s+/g, '_') || "Angebot";

    html2pdf().from(el).set({
        margin: 10,
        filename: `Angebot_${k}_${a}.pdf`,
        html2canvas: {
            scale: 2.5,
            useCORS: true
        },
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        }
    }).save();
}

    function showPreview() {
	

        const fmt = (v) => v.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });


 document.getElementById('pdf-out-kunde').innerText = document.getElementById('kunde').value || "Interessent";
        document.getElementById('pdf-out-anlass').innerText = document.getElementById('anlass').value || "Angebot";
        document.getElementById('pdf-out-ort').innerText = document.getElementById('datumOrt').value;
        document.getElementById('pdf-out-datum').innerText =    formatDateDE();


        const rows = document.getElementById('pdf-rows');
        rows.innerHTML = '<h3 style="border-bottom:1px solid #ccc; padding-bottom:5px;">Leistungen</h3>';
        
        const vOrt = parseFloat(document.getElementById('vorOrt').value) || 0;
        if(vOrt > 0) rows.innerHTML += `<div class="pdf-row"><span>Shooting & Nachbearbeitung</span><span>${fmt((vOrt*PREISE.stdVorOrt)+(vOrt*2.25*PREISE.stdBearb))}</span></div>`;
        const kmVal = Math.max(0, (parseFloat(document.getElementById('km').value)||0)-PREISE.kmFrei)*PREISE.kmSatz;
        if(kmVal > 0) rows.innerHTML += `<div class="pdf-row"><span>Fahrtkosten</span><span>${fmt(kmVal)}</span></div>`;
        CUSTOM_FIELDS.filter(f=>f.active && f.type==='leistung').forEach(f=>{ rows.innerHTML += `<div class="pdf-row"><span>${f.name}</span><span>${fmt(f.price)}</span></div>`; });

        rows.innerHTML += '<h3 style="margin-top:20px; border-bottom:1px solid #ccc; padding-bottom:5px;">Produkte & Material</h3>';
        const nAbz = parseInt(document.getElementById('abzuege').value) || 0;
        if(nAbz > 0) rows.innerHTML += `<div class="pdf-row"><span>${nAbz} Abz√ºge 21x15cm</span><span>${fmt((nAbz*PREISE.abzug)+PREISE.saalShip)}</span></div>`;
        if(document.querySelector('input[name="usb_choice"]:checked').value==='ja') rows.innerHTML += `<div class="pdf-row"><span>Alle Bilder auf einem USB-Stick</span><span>${fmt(PREISE.usb+(parseFloat(document.getElementById('versandUsb').value)||0))}</span></div>`;
        if(document.querySelector('input[name="geschenk_choice"]:checked').value==='ja') rows.innerHTML += `<div class="pdf-row"><span>Geschenkbox</span><span>${fmt(PREISE.geschenk+(parseFloat(document.getElementById('versandGeschenk').value)||0))}</span></div>`;
        
        if(document.querySelector('input[name="fotobox"]:checked').value==='ja') {
            const pap = document.querySelector('input[name="papier"]:checked').value;
            let bTxt = "Fotobox Miete (Digital)";
            let bPrice = PREISE.box;
            if(pap==="400") { bTxt = "Fotobox inkl. 400 Blatt"; bPrice += PREISE.p400 + PREISE.pShip; }
            if(pap==="800") { bTxt = "Fotobox inkl. 800 Blatt"; bPrice += PREISE.p800 + PREISE.pShip; }
            rows.innerHTML += `<div class="pdf-row"><span>${bTxt}</span><span>${fmt(bPrice)}</span></div>`;
        }
        CUSTOM_FIELDS.filter(f=>f.active && f.type==='produkt').forEach(f=>{ rows.innerHTML += `<div class="pdf-row"><span>${f.name}</span><span>${fmt(f.price)}</span></div>`; });

        document.getElementById('pdf-final-sum').innerText = "Gesamtbetrag: " + document.getElementById('total').innerText;
        document.getElementById('preview-modal').style.display = 'block';
    }

    function closePreview() { document.getElementById('preview-modal').style.display = 'none'; }

    initSettings(); updateAll();
if (isMobile) {
    const btn = document.getElementById('pdf-btn');
    if (btn) {
        btn.innerText = "PDF bitte am Desktop herunterladen";
    }
}

</script>
</body>
</html>